# å‘å¸ƒå·¥ä½œæµ
#
# è§¦å‘æ–¹å¼ï¼š
# 1. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
#
# åŠŸèƒ½ï¼š
# - æ„å»º Node.js æˆ– Electron ç‰ˆæœ¬çš„å‘å¸ƒåŒ…
# - åˆ›å»º ZIP å‹ç¼©åŒ…
# - ä¸Šä¼ å‘å¸ƒåŒ…åˆ° FTP æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰

name: Publish

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      nodejs:
        description: 'å‘å¸ƒ Node.js ç‰ˆæœ¬'
        required: false
        default: true
        type: boolean
      electron:
        description: 'å‘å¸ƒ Electron ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      create-zip:
        description: 'åˆ›å»º ZIP å‹ç¼©åŒ…'
        required: true
        default: true
        type: boolean
      upload-ftp:
        description: 'ä¸Šä¼ åˆ° FTP æœåŠ¡å™¨'
        required: true
        default: false
        type: boolean
      send-feishu:
        description: 'å‘é€å‘å¸ƒç»“æœåˆ°é£ä¹¦'
        required: true
        default: false
        type: boolean

permissions:
  contents: read          # è¯»å–ä»£ç 
  actions: read          # è¯»å– Actions

jobs:
  publish:
    runs-on: [ macOS ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
      
      - name: Setup configuration
        id: setup-config
        uses: ./.github/actions/setup-config
        with:
          feishu-webhook-url: ${{ secrets.FEISHU_WEBHOOK_URL }}
      
      - name: Setup environment
        uses: ./.github/actions/setup-env
      
      - name: Release build
        id: release
        if: inputs.nodejs == true || inputs.electron == true
        uses: ./.github/actions/release
        with:
          publish-dir: .publish
          nodejs: ${{ inputs.nodejs == true && 'true' || 'false' }}
          electron: ${{ inputs.electron == true && 'true' || 'false' }}
          create-zip: ${{ inputs.create-zip == true && 'true' || 'false' }}
          upload: ${{ inputs.upload-ftp == true && 'true' || 'false' }}
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
      
      - name: Summary
        if: always()
        env:
          RELEASE_RESULTS: ${{ steps.release.outputs.release_results }}
        run: |
          echo "## ğŸ“¦ å‘å¸ƒç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$RELEASE_RESULTS" ] || [ "$RELEASE_RESULTS" == "null" ]; then
            echo "âš ï¸ **æœªæ‰§è¡Œå‘å¸ƒæµç¨‹æˆ–å‘å¸ƒå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # ä½¿ç”¨ Node.js è§£æ JSON å¹¶ç”Ÿæˆæ‘˜è¦
          node -e "
          const results = JSON.parse(process.env.RELEASE_RESULTS);
          const fs = require('fs');
          const summaryFile = process.env.GITHUB_STEP_SUMMARY;
          let summary = '';
          
          if (results.nodejs) {
            if (results.nodejs.success) {
              summary += '### âœ… Node.js å‘å¸ƒæˆåŠŸ\\n';
              summary += '- **å‘å¸ƒç›®å½•**: ' + results.nodejs.releaseDir + '\\n';
              if (results.nodejs.zipFile) {
                summary += '- **ZIP æ–‡ä»¶**: ' + results.nodejs.zipFile + '\\n';
                summary += '- **ZIP URL**: ' + results.nodejs.zipUrl + '\\n';
              }
            } else {
              summary += '### âŒ Node.js å‘å¸ƒå¤±è´¥\\n';
            }
            summary += '\\n';
          }
          
          if (results.electron) {
            if (results.electron.success) {
              summary += '### âœ… Electron å‘å¸ƒæˆåŠŸ\\n';
              summary += '- **å‘å¸ƒç›®å½•**: ' + results.electron.releaseDir + '\\n';
              if (results.electron.zipFile) {
                summary += '- **ZIP æ–‡ä»¶**: ' + results.electron.zipFile + '\\n';
                summary += '- **ZIP URL**: ' + results.electron.zipUrl + '\\n';
              }
            } else {
              summary += '### âŒ Electron å‘å¸ƒå¤±è´¥\\n';
            }
            summary += '\\n';
          }
          
          fs.appendFileSync(summaryFile, summary);
          "
      
      - name: Send to Feishu
        if: always() && inputs.send-feishu == true
        continue-on-error: true
        run: node .github/scripts/send-release-to-feishu.js
        env:
          FEISHU_WEBHOOK_URL: ${{ steps.setup-config.outputs.FEISHU_WEBHOOK_URL }}
          RELEASE_RESULTS: ${{ steps.release.outputs.release_results }}
          RUN_ID: ${{ github.run_id }}
          TRIGGER_TYPE: ${{ github.event_name }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}

