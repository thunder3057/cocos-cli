name: PR Test

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  issue_comment:
    types: [created]

jobs:
  pr-test:
    # è¿è¡Œæ¡ä»¶ï¼š
    # 1. PR äº‹ä»¶
    # 2. è¯„è®ºè§¦å‘ (åŒ…å« "rerun pr test"ï¼ŒåŒ…æ‹¬ "rerun pr test:debug")
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'rerun pr test'))
    
    runs-on: [ pr-test ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
          # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ï¼Œéœ€è¦æ£€å‡º PR çš„ä»£ç 
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      
      - name: Setup configuration
        id: setup-config
        uses: ./.github/actions/setup-config
        with:
          feishu-webhook-url: ${{ secrets.FEISHU_WEBHOOK_URL }}
      
      - name: Setup environment
        uses: ./.github/actions/setup-env
      
      - name: Run unit tests
        id: unit-tests
        run: npm run test:quiet
      
      - name: Run E2E tests
        id: e2e-tests
        uses: ./.github/actions/run-e2e-tests
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
          # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ä¸”åŒ…å« "rerun pr test:debug"ï¼Œåˆ™ä»¥ debug æ¨¡å¼è¿è¡Œ E2E
          debug: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'rerun pr test:debug') }}
      
      - name: Check E2E coverage
        id: coverage
        uses: ./.github/actions/check-e2e-coverage
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
      
      - name: Generate PR comment
        if: always()
        id: message
        run: |
          # åˆ¤æ–­æ•´ä½“çŠ¶æ€
          ALL_PASS=true
          
          # æ£€æŸ¥å•å…ƒæµ‹è¯•çŠ¶æ€ï¼ˆé€šè¿‡æ£€æŸ¥ unit-tests æ­¥éª¤çš„ outcomeï¼‰
          if [ "${{ steps.unit-tests.outcome }}" != "success" ]; then
            ALL_PASS=false
          fi
          
          # E2E æµ‹è¯•çŠ¶æ€ï¼ˆé€šè¿‡ outcome åˆ¤æ–­ï¼‰
          if [ "${{ steps.e2e-tests.outcome }}" != "success" ]; then
            ALL_PASS=false
          fi
          
          # è¦†ç›–ç‡æ£€æŸ¥ä»…ä½œä¸ºä¿¡æ¯å±•ç¤ºï¼Œä¸å½±å“æ•´ä½“çŠ¶æ€
          
          # æ„å»ºç´§å‡‘å‹æ¶ˆæ¯
          if [ "$ALL_PASS" = "false" ]; then
            MESSAGE="## âš ï¸ å‘ç°é—®é¢˜\n\n"
          else
            MESSAGE="## âœ… æµ‹è¯•é€šè¿‡\n\n"
          fi
          MESSAGE+="| ç±»å‹ | ç»“æœ |\n"
          MESSAGE+="|:----:|------|\n"
          
          # å•å…ƒæµ‹è¯•è¡Œï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼‰
          if [ "${{ steps.unit-tests.outcome }}" = "success" ]; then
            MESSAGE+="| ğŸ§ª | âœ… å•å…ƒæµ‹è¯• |\n"
          else
            MESSAGE+="| ğŸ§ª | âŒ å•å…ƒæµ‹è¯•å¤±è´¥ |\n"
          fi
          
          # E2E æµ‹è¯•è¡Œï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼‰
          # è·å–æŠ¥å‘Š URLï¼ˆæ— è®ºæµ‹è¯•æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰
          REPORT_URL="${{ steps.e2e-tests.outputs.report_url }}"
          
          # æ£€æŸ¥æµ‹è¯•æ˜¯å¦é€šè¿‡ï¼ˆé€šè¿‡æ£€æŸ¥ outcomeï¼‰
          if [ "${{ steps.e2e-tests.outcome }}" = "success" ]; then
            # æµ‹è¯•æˆåŠŸ
            if [ -n "$REPORT_URL" ]; then
              MESSAGE+="| ğŸ”„ | âœ… E2E æµ‹è¯• Â· [æŠ¥å‘Š]($REPORT_URL) |\n"
            else
              MESSAGE+="| ğŸ”„ | âœ… E2E æµ‹è¯• |\n"
            fi
          else
            # æµ‹è¯•å¤±è´¥ï¼Œä½†ä»é™„ä¸ŠæŠ¥å‘Šé“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -n "$REPORT_URL" ]; then
              MESSAGE+="| ğŸ”„ | âŒ E2E æµ‹è¯•å¤±è´¥ Â· [æŸ¥çœ‹æŠ¥å‘Š]($REPORT_URL) |\n"
            else
              MESSAGE+="| ğŸ”„ | âŒ E2E æµ‹è¯•å¤±è´¥ |\n"
            fi
          fi
          
          # è¦†ç›–ç‡è¡Œï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼Œä½†ä¸å½±å“æµ‹è¯•ç»“æœï¼‰
          # è·å–è¦†ç›–ç‡ä¿¡æ¯
          COVERAGE_URL="${{ steps.coverage.outputs.report_url }}"
          COVERAGE_PERCENT="${{ steps.coverage.outputs.coverage_percent }}"
          TESTED_COUNT="${{ steps.coverage.outputs.tested_count }}"
          TOTAL_COUNT="${{ steps.coverage.outputs.total_count }}"
          
          # æ˜¾ç¤ºè¦†ç›–ç‡ç™¾åˆ†æ¯”ï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
          if [ -n "$COVERAGE_PERCENT" ] && [ -n "$COVERAGE_URL" ]; then
            MESSAGE+="| ğŸ“ˆ | è¦†ç›–ç‡ ${COVERAGE_PERCENT}% (${TESTED_COUNT}/${TOTAL_COUNT}) Â· [è¯¦æƒ…]($COVERAGE_URL) |\n"
          elif [ -n "$COVERAGE_URL" ]; then
            MESSAGE+="| ğŸ“ˆ | è¦†ç›–ç‡æŠ¥å‘Š Â· [è¯¦æƒ…]($COVERAGE_URL) |\n"
          else
            MESSAGE+="| ğŸ“ˆ | âš ï¸ è¦†ç›–ç‡æ£€æŸ¥å¤±è´¥ |\n"
          fi
          
          MESSAGE+="\n<sub>Run #${{ github.run_id }}</sub>\n"
          MESSAGE+="<!-- PR_TEST_COMMENT -->"
          
          # ä¿å­˜åˆ° GitHub Output
          {
            echo 'content<<EOF'
            echo -e "$MESSAGE"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        if: always()
        uses: ./.github/actions/comment-on-pr
        with:
          pat-token: ${{ steps.setup-config.outputs.PAT_TOKEN }}
          message: ${{ steps.message.outputs.content }}
          comment-identifier: 'PR æµ‹è¯•æŠ¥å‘Š'
