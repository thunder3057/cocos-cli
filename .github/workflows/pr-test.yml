name: PR Test

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  issue_comment:
    types: [created]

jobs:
  pr-test:
    # 运行条件：
    # 1. PR 事件
    # 2. 评论触发 (包含 "rerun pr test"，包括 "rerun pr test:debug")
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'rerun pr test'))
    
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
          # 如果是评论触发，需要检出 PR 的代码
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: '22.17.0'
      - name: Setup configuration
        id: setup-config
        uses: ./.github/actions/setup-config
        with:
          feishu-webhook-url: ${{ secrets.FEISHU_WEBHOOK_URL }}
      
      - name: Setup environment
        uses: ./.github/actions/setup-env
      
      - name: Run unit tests
        id: unit-tests
        run: npm run test:quiet
      
      - name: Run E2E tests
        id: e2e-tests
        uses: ./.github/actions/run-e2e-tests
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}
          # 如果是评论触发且包含 "rerun pr test:debug"，则以 debug 模式运行 E2E
          debug: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'rerun pr test:debug') }}
      
      - name: Check E2E coverage
        id: coverage
        uses: ./.github/actions/check-e2e-coverage
        with:
          report-server-url: ${{ steps.setup-config.outputs.REPORT_SERVER_URL }}

