# æ¯æ—¥ E2E æµ‹è¯•ä¸è¦†ç›–ç‡æ£€æŸ¥å·¥ä½œæµ
#
# è§¦å‘æ–¹å¼ï¼š
# 1. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 2. å®šæ—¶è§¦å‘ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 00:00ï¼ˆUTC 16:00ï¼‰
#
# åŠŸèƒ½ï¼š
# - è¿è¡Œå®Œæ•´çš„ E2E æµ‹è¯•å¥—ä»¶
# - ç”Ÿæˆå¯è§†åŒ–çš„ HTML æµ‹è¯•æŠ¥å‘Š
# - æ£€æŸ¥ E2E æµ‹è¯•è¦†ç›–ç‡
# - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
# - å‘é€æµ‹è¯•ç»“æœå’Œè¦†ç›–ç‡åˆ°é£ä¹¦ç¾¤èŠ
# - ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šä¸º GitHub Artifactsï¼ˆä¿ç•™ 30 å¤©ï¼‰

name: Daily E2E Check

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©å‡Œæ™¨ 12 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ = UTC+8ï¼Œæ‰€ä»¥ UTC æ—¶é—´æ˜¯ 16:00ï¼‰
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤© UTC 16:00 = åŒ—äº¬æ—¶é—´ 00:00

env:
  # é…ç½®æµ‹è¯•æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€
  REPORT_SERVER_URL: 'http://192.168.52.77:8080'
  # é£ä¹¦ Webhook URLï¼ˆä» Secrets ä¸­è¯»å–ï¼‰
  FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}

permissions:
  contents: read          # è¯»å–ä»£ç 
  actions: read          # è¯»å– Actions

jobs:
  daily-check:
    runs-on: [ self-hosted, macOS ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
      
      - name: Init
        run: npm run init

      - name: Install dependencies
        run: npm i
      
      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: true
      
      - name: Check E2E test coverage
        id: coverage
        if: always()
        run: node .github/scripts/check-e2e-coverage.js
      
      - name: Find test report file
        if: always()
        id: find-report
        run: node .github/scripts/find-test-report.js
      
      - name: Upload test report to server
        if: always() && steps.find-report.outputs.report_exists == 'true'
        run: |
          echo "ğŸ“¤ Uploading test report to server..."
          echo "Report file: ${{ steps.find-report.outputs.report_file }}"
          echo "Report URL: ${{ steps.find-report.outputs.report_url }}"
          
          # è¿™é‡Œæ·»åŠ ä½ ä¸Šä¼ æŠ¥å‘Šåˆ°æœåŠ¡å™¨çš„å‘½ä»¤
          # ä¾‹å¦‚ä½¿ç”¨ scp, rsync, curl ç­‰
          # scp ${{ steps.find-report.outputs.report_file }} user@server:/path/to/reports/
          # æˆ–è€…
          # curl -F "file=@${{ steps.find-report.outputs.report_file }}" ${{ env.REPORT_SERVER_URL }}/upload

          echo "âœ… Report uploaded successfully"
      
      - name: Upload test report as artifact
        if: always() && steps.find-report.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-e2e-report-${{ github.run_id }}
          path: ${{ steps.find-report.outputs.report_file }}
          retention-days: 30
      
      - name: Generate coverage report HTML
        id: coverage-report
        if: always()
        run: npm run check:e2e-coverage:report
      
      - name: Upload coverage report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-coverage-report-${{ github.run_id }}
          path: e2e/reports/coverage-report-*.html
          retention-days: 30
      
      - name: Send to Feishu
        if: always()
        continue-on-error: true
        run: node .github/scripts/send-to-feishu.js
        env:
          REPORT_EXISTS: ${{ steps.find-report.outputs.report_exists }}
          REPORT_URL: ${{ steps.find-report.outputs.report_url }}
          REPORT_FILENAME: ${{ steps.find-report.outputs.report_filename }}
          COVERAGE_PERCENT: ${{ steps.coverage.outputs.coverage_percent }}
          COVERAGE_REPORT: ${{ steps.coverage.outputs.coverage_report }}

