# E2E æµ‹è¯•å·¥ä½œæµ - PR æµ‹è¯•
#
# è§¦å‘æ–¹å¼ï¼š
# 1. è¯„è®ºè§¦å‘ï¼šåœ¨ Issue æˆ– PR ä¸­è¯„è®º "run e2e test"
# 2. PR è§¦å‘ï¼šåœ¨ PR æè¿°ä¸­åŒ…å« "run e2e test"
#
# åŠŸèƒ½ï¼š
# - è¿è¡Œå®Œæ•´çš„ E2E æµ‹è¯•å¥—ä»¶
# - ç”Ÿæˆå¯è§†åŒ–çš„ HTML æµ‹è¯•æŠ¥å‘Š
# - åœ¨ PR ä¸­è‡ªåŠ¨è¯„è®ºæµ‹è¯•ç»“æœå’ŒæŠ¥å‘Šé“¾æ¥
# - ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šä¸º GitHub Artifactsï¼ˆä¿ç•™ 30 å¤©ï¼‰
#
# æ³¨æ„ï¼šæ­¤å·¥ä½œæµä¸åŒ…å«è¦†ç›–ç‡æ£€æŸ¥ï¼Œå¦‚éœ€æ£€æŸ¥è¦†ç›–ç‡è¯·ä½¿ç”¨ e2e-coverage.yml

name: E2E Tests (PR)

on:
  # è¯„è®ºè§¦å‘ï¼šåœ¨ Issue æˆ– PR ä¸­è¯„è®º "run e2e test"
  issue_comment:
    types: [created]
  
  # PR è§¦å‘ï¼šå½“ PR æ‰“å¼€ã€æ›´æ–°æˆ–åŒæ­¥æ—¶æ£€æŸ¥æè¿°
  pull_request:
    types: [opened, synchronize, reopened]

env:
  # é…ç½®æµ‹è¯•æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€
  REPORT_SERVER_URL: 'http://192.168.52.77:8080'

permissions:
  contents: read          # è¯»å–ä»£ç 
  issues: write          # è¯„è®º Issue
  pull-requests: write   # è¯„è®º PR
  actions: read          # è¯»å– Actions
  checks: write          # å†™å…¥æ£€æŸ¥ç»“æœ

jobs:
  e2e-tests:
    # è¿è¡Œæ¡ä»¶ï¼š
    # 1. è¯„è®ºè§¦å‘ (issue_comment) - è¯„è®ºåŒ…å« "run e2e test"
    # 2. PR è§¦å‘ (pull_request) - PR æè¿°åŒ…å« "run e2e test"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'run e2e test')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'run e2e test'))
    
    runs-on: [ self-hosted, macOS ]
    
    env:
      HAS_PAT_TOKEN: ${{ secrets.PAT_TOKEN != '' }}

    steps:
      - name: Check PAT_TOKEN configuration
        if: env.HAS_PAT_TOKEN == 'false'
        run: |
          echo "âš ï¸  PAT_TOKEN is not configured"
          echo "Comment features will be disabled"
          echo "See: .github/workflows/PAT-TOKEN-SETUP.md for setup instructions"
      
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request && env.HAS_PAT_TOKEN == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            try {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
              console.log('âœ… Reaction added');
            } catch (error) {
              console.log('âš ï¸ Could not add reaction:', error.message);
            }
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
          # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ï¼Œéœ€è¦æ£€å‡º PR çš„ä»£ç 
          # pull_request äº‹ä»¶ä¼šè‡ªåŠ¨æ£€å‡º PR çš„ head
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      
      - name: Init
        run: npm run init

      - name: Install dependencies
        run: npm i
      
      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: true
      
      - name: Find test report file
        if: always()
        id: find-report
        run: node .github/scripts/find-test-report.js
      
      - name: Upload test report to server
        if: always() && steps.find-report.outputs.report_exists == 'true'
        run: |
          echo "ğŸ“¤ Uploading test report to server..."
          echo "Report file: ${{ steps.find-report.outputs.report_file }}"
          echo "Report URL: ${{ steps.find-report.outputs.report_url }}"
          
          # è¿™é‡Œæ·»åŠ ä½ ä¸Šä¼ æŠ¥å‘Šåˆ°æœåŠ¡å™¨çš„å‘½ä»¤
          # ä¾‹å¦‚ä½¿ç”¨ scp, rsync, curl ç­‰
          # scp ${{ steps.find-report.outputs.report_file }} user@server:/path/to/reports/
          # æˆ–è€…
          # curl -F "file=@${{ steps.find-report.outputs.report_file }}" ${{ env.REPORT_SERVER_URL }}/upload

          echo "âœ… Report uploaded successfully"
      
      - name: Upload test report as artifact (å¤‡ç”¨)
        if: always() && steps.find-report.outputs.report_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report-${{ github.run_id }}
          path: ${{ steps.find-report.outputs.report_file }}
          retention-days: 30
      
      - name: Generate message content
        if: always()
        id: message
        run: |
          # ç”Ÿæˆæ¶ˆæ¯å†…å®¹å¹¶ä¿å­˜åˆ°æ–‡ä»¶
          MESSAGE=$(node .github/scripts/generate-message.js)
          
          # ä¿å­˜åˆ° GitHub Outputï¼ˆå¤„ç†å¤šè¡Œï¼‰
          {
            echo 'content<<EOF'
            echo "$MESSAGE"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
        env:
          REPORT_EXISTS: ${{ steps.find-report.outputs.report_exists }}
          REPORT_URL: ${{ steps.find-report.outputs.report_url }}
          REPORT_FILENAME: ${{ steps.find-report.outputs.report_filename }}
          GITHUB_RUN_ID: ${{ github.run_id }}
      
      - name: Comment on PR
        if: always() && env.HAS_PAT_TOKEN == 'true' && (github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request))
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const comment = process.env.MESSAGE_CONTENT;
            
            // è·å– issue/PR ç¼–å·
            const issueNumber = context.issue?.number || context.payload.issue?.number;
            
            if (!issueNumber) {
              console.log('âš ï¸ Could not determine issue number');
              return;
            }
            
            console.log(`ğŸ“ Commenting on issue/PR #${issueNumber}`);
            
            try {
              // æŸ¥æ‰¾å·²æœ‰çš„æµ‹è¯•æŠ¥å‘Šè¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const botComment = comments.find(c => 
                c.user.type === 'Bot' && 
                c.body.includes('E2E æµ‹è¯•æŠ¥å‘Š')
              );
              
              if (botComment) {
                // æ›´æ–°å·²æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log('âœ… Comment updated');
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log('âœ… Comment created');
              }
            } catch (error) {
              console.log('âŒ Failed to comment:', error.message);
              console.log('Response status:', error.status);
              console.log('Response data:', JSON.stringify(error.response?.data, null, 2));
              throw error;
            }
        env:
          MESSAGE_CONTENT: ${{ steps.message.outputs.content }}

