# E2E æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥å·¥ä½œæµ
#
# è§¦å‘æ–¹å¼ï¼š
# 1. æ‰‹åŠ¨è§¦å‘ï¼šåœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
# 2. è¯„è®ºè§¦å‘ï¼šåœ¨ Issue æˆ– PR ä¸­è¯„è®º "check e2e coverage"
#
# åŠŸèƒ½ï¼š
# - æ£€æŸ¥ E2E æµ‹è¯•è¦†ç›–ç‡
# - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
# - åœ¨ PR ä¸­è‡ªåŠ¨è¯„è®ºè¦†ç›–ç‡ç»“æœ

name: E2E Coverage Check

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # è¯„è®ºè§¦å‘ï¼šåœ¨ Issue æˆ– PR ä¸­è¯„è®º "check e2e coverage"
  issue_comment:
    types: [created]

permissions:
  contents: read          # è¯»å–ä»£ç 
  issues: write          # è¯„è®º Issue
  pull-requests: write   # è¯„è®º PR

jobs:
  coverage-check:
    # è¿è¡Œæ¡ä»¶ï¼š
    # 1. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) - ç›´æ¥è¿è¡Œ
    # 2. è¯„è®ºè§¦å‘ (issue_comment) - è¯„è®ºåŒ…å« "check e2e coverage"
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'check e2e coverage'))
    
    runs-on: [ self-hosted, macOS ]
    
    env:
      HAS_PAT_TOKEN: ${{ secrets.PAT_TOKEN != '' }}

    steps:
      - name: Check PAT_TOKEN configuration
        if: env.HAS_PAT_TOKEN == 'false'
        run: |
          echo "âš ï¸  PAT_TOKEN is not configured"
          echo "Comment features will be disabled"
          echo "See: .github/workflows/PAT-TOKEN-SETUP.md for setup instructions"
      
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment' && env.HAS_PAT_TOKEN == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            try {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
              console.log('âœ… Reaction added');
            } catch (error) {
              console.log('âš ï¸ Could not add reaction:', error.message);
            }
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false
          persist-credentials: true
          fetch-depth: 0
          # å¦‚æœæ˜¯è¯„è®ºè§¦å‘ï¼Œéœ€è¦æ£€å‡º PR çš„ä»£ç 
          ref: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}
      
      - name: Check E2E test coverage
        id: coverage
        run: node .github/scripts/check-e2e-coverage.js
      
      - name: Generate coverage report HTML
        id: coverage-report
        run: npm run check:e2e-coverage:report
      
      - name: Generate message content
        id: message
        run: |
          # ç”Ÿæˆè¦†ç›–ç‡æ¶ˆæ¯
          MESSAGE="## ğŸ“Š E2E æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š\n\n"
          MESSAGE+="${{ steps.coverage.outputs.coverage_report }}\n\n"
          MESSAGE+="---\n\n"
          MESSAGE+="<sub>ğŸ¤– æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | Run ID: ${{ github.run_id }}</sub>"
          
          # ä¿å­˜åˆ° GitHub Output
          {
            echo 'content<<EOF'
            echo -e "$MESSAGE"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
      
      - name: Comment on PR or Issue
        if: github.event_name == 'issue_comment' && env.HAS_PAT_TOKEN == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const comment = process.env.MESSAGE_CONTENT;
            const issueNumber = context.payload.issue.number;
            
            if (!issueNumber) {
              console.log('âš ï¸ Could not determine issue number');
              return;
            }
            
            console.log(`ğŸ“ Commenting on issue/PR #${issueNumber}`);
            
            try {
              // æŸ¥æ‰¾å·²æœ‰çš„è¦†ç›–ç‡æŠ¥å‘Šè¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              
              const botComment = comments.find(c => 
                c.user.type === 'Bot' && 
                c.body.includes('E2E æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š')
              );
              
              if (botComment) {
                // æ›´æ–°å·²æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log('âœ… Coverage comment updated');
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                console.log('âœ… Coverage comment created');
              }
            } catch (error) {
              console.log('âŒ Failed to comment:', error.message);
              console.log('Response status:', error.status);
              console.log('Response data:', JSON.stringify(error.response?.data, null, 2));
              throw error;
            }
        env:
          MESSAGE_CONTENT: ${{ steps.message.outputs.content }}

