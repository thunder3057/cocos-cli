name: 'Setup Configuration'
description: 'è·å–é…ç½®é¡¹ï¼ˆæ”¯æŒä» GitHub Secrets æˆ–æœ¬åœ° .user.json è¯»å–ï¼‰å¹¶è®¾ç½®ç¯å¢ƒå˜é‡'

inputs:
  report-server-url:
    description: 'æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€'
    required: false
    default: 'http://192.168.52.77:8080'
  github-token:
    description: 'GitHub Token (é»˜è®¤ä½¿ç”¨ GITHUB_TOKEN)'
    required: false
    default: ${{ github.token }}
  feishu-webhook-url:
    description: 'é£ä¹¦ Webhook URL'
    required: false
    default: ''

outputs:
  FEISHU_WEBHOOK_URL:
    description: 'é£ä¹¦ Webhook URL'
    value: ${{ steps.resolve-config.outputs.feishu_webhook_url }}
  PAT_TOKEN:
    description: 'GitHub Token (ç”¨äºè¯„è®º PR)'
    value: ${{ steps.resolve-config.outputs.pat_token }}
  HTTP_PROXY:
    description: 'HTTP ä»£ç†åœ°å€'
    value: ${{ steps.resolve-config.outputs.http_proxy }}
  HTTPS_PROXY:
    description: 'HTTPS ä»£ç†åœ°å€'
    value: ${{ steps.resolve-config.outputs.https_proxy }}
  REPORT_SERVER_URL:
    description: 'æŠ¥å‘ŠæœåŠ¡å™¨åœ°å€'
    value: ${{ steps.resolve-config.outputs.report_server_url }}

runs:
  using: 'composite'
  steps:
    - name: Load configuration from .user.json
      id: load-config
      shell: bash
      run: |
        # ç»Ÿä¸€è¯»å– .user.json æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        USER_JSON_PATH=".user.json"
        
        if [ -f "$USER_JSON_PATH" ]; then
          echo "ğŸ” å‘ç° .user.json æ–‡ä»¶ï¼Œè¯»å–é…ç½®..."
          # ä½¿ç”¨ Node.js è¯»å–å¹¶è¾“å‡ºæ‰€æœ‰é…ç½®
          # stdout è¾“å‡ºé…ç½®å€¼ï¼ˆUSER_KEY=value æ ¼å¼ï¼‰
          # stderr è¾“å‡ºæ—¥å¿—ï¼ˆæ˜¾ç¤ºåœ¨æ§åˆ¶å°ï¼‰
          node -e "
            const fs = require('fs');
            try {
              const config = JSON.parse(fs.readFileSync('$USER_JSON_PATH', 'utf-8'));
              const keys = ['HTTP_PROXY', 'HTTPS_PROXY', 'REPORT_SERVER_URL', 'FEISHU_WEBHOOK_URL', 'PAT_TOKEN'];
              keys.forEach(key => {
                if (config[key]) {
                  // stdout: é…ç½®å€¼
                  process.stdout.write('USER_' + key + '=' + config[key] + '\\n');
                  // stderr: æ—¥å¿—
                  process.stderr.write('âœ… ä» .user.json è¯»å–åˆ° ' + key + '\\n');
                }
              });
            } catch (e) {
              process.stderr.write('âš ï¸  è¯»å– .user.json å¤±è´¥: ' + e.message + '\\n');
            }
          " > /tmp/user-config-cache.env || true
        else
          echo "â„¹ï¸  æœªæ‰¾åˆ° .user.json æ–‡ä»¶ï¼Œè·³è¿‡æœ¬åœ°é…ç½®"
          # åˆ›å»ºç©ºæ–‡ä»¶ï¼Œç¡®ä¿åç»­æ­¥éª¤ä¸ä¼šå‡ºé”™
          touch /tmp/user-config-cache.env
        fi
    
    - name: Resolve all configurations
      id: resolve-config
      shell: bash
      run: |
        # åŠ è½½ç”¨æˆ·é…ç½®ï¼ˆä»ä¸´æ—¶æ–‡ä»¶è¯»å–ï¼Œstderr åŒ…å«æ—¥å¿—ï¼‰
        USER_HTTP_PROXY=""
        USER_HTTPS_PROXY=""
        USER_REPORT_SERVER_URL=""
        USER_FEISHU_WEBHOOK_URL=""
        USER_PAT_TOKEN=""
        
        if [ -f /tmp/user-config-cache.env ]; then
          # ä»ä¸´æ—¶æ–‡ä»¶è¯»å–é…ç½®ï¼ˆè¿‡æ»¤æ‰ stderr çš„æ—¥å¿—ä¿¡æ¯ï¼‰
          while IFS='=' read -r key value || [ -n "$key" ]; do
            # è·³è¿‡ç©ºè¡Œå’Œæ—¥å¿—è¡Œ
            if [[ "$key" =~ ^USER_ ]] && [ -n "$value" ]; then
              eval "${key}=\"$value\""
            fi
          done < <(grep "^USER_" /tmp/user-config-cache.env 2>/dev/null || true)
        fi
        
        # ç»Ÿä¸€çš„è§£æå‡½æ•°ï¼šä¼˜å…ˆä» .user.jsonï¼Œç„¶åæ˜¯ inputsï¼Œæœ€åæ˜¯é»˜è®¤å€¼
        resolve_config() {
          local key=$1
          local input_value=$2
          local default_value=$3
          local user_var="USER_${key}"
          local user_value=$(eval "echo \${${user_var}:-}")
          
          if [ -n "$user_value" ]; then
            echo "$user_value"
            echo "âœ… ${key}: ä» .user.json è¯»å–" >&2
          elif [ -n "$input_value" ]; then
            echo "$input_value"
            echo "âœ… ${key}: ä½¿ç”¨ä¼ å…¥çš„å€¼" >&2
          else
            echo "$default_value"
            echo "â„¹ï¸  ${key}: ä½¿ç”¨é»˜è®¤å€¼" >&2
          fi
        }
        
        # è§£ææ‰€æœ‰é…ç½®é¡¹ï¼ˆæœ‰é»˜è®¤å€¼çš„ï¼‰
        REPORT_SERVER_URL=$(resolve_config "REPORT_SERVER_URL" "${{ inputs.report-server-url }}" "http://192.168.52.77:8080")
        
        # FEISHU_WEBHOOK_URL: ä¼˜å…ˆçº§æ˜¯ .user.json > inputs (æ²¡æœ‰é»˜è®¤å€¼)
        if [ -n "${USER_FEISHU_WEBHOOK_URL:-}" ]; then
          FEISHU_WEBHOOK_URL="${USER_FEISHU_WEBHOOK_URL}"
          echo "âœ… FEISHU_WEBHOOK_URL: ä» .user.json è¯»å–" >&2
        elif [ -n "${{ inputs.feishu-webhook-url }}" ]; then
          FEISHU_WEBHOOK_URL="${{ inputs.feishu-webhook-url }}"
          echo "âœ… FEISHU_WEBHOOK_URL: ä½¿ç”¨ä¼ å…¥çš„å€¼" >&2
        else
          FEISHU_WEBHOOK_URL=""
          echo "âš ï¸  FEISHU_WEBHOOK_URL: æœªæ‰¾åˆ°ï¼Œé£ä¹¦é€šçŸ¥åŠŸèƒ½å°†è¢«è·³è¿‡" >&2
        fi
        
        # PAT_TOKEN / GitHub Token: ä¼˜å…ˆçº§æ˜¯ .user.json (PAT_TOKEN) > inputs (github-tokenï¼Œé€šå¸¸æ˜¯ github.token)
        if [ -n "${USER_PAT_TOKEN:-}" ]; then
          PAT_TOKEN="${USER_PAT_TOKEN}"
          echo "âœ… PAT_TOKEN: ä» .user.json è¯»å–" >&2
        elif [ -n "${{ inputs.github-token }}" ]; then
          PAT_TOKEN="${{ inputs.github-token }}"
          echo "âœ… PAT_TOKEN: ä½¿ç”¨ GitHub Actions token" >&2
        else
          PAT_TOKEN=""
          echo "âš ï¸  PAT_TOKEN: æœªæ‰¾åˆ°ï¼Œè¯„è®ºåŠŸèƒ½å°†è¢«è·³è¿‡" >&2
        fi
        
        # è¾“å‡ºæ‰€æœ‰é…ç½®åˆ° GITHUB_OUTPUT
        {
          echo "http_proxy=$HTTP_PROXY"
          echo "https_proxy=$HTTPS_PROXY"
          echo "report_server_url=$REPORT_SERVER_URL"
          echo "feishu_webhook_url=$FEISHU_WEBHOOK_URL"
          echo "pat_token=$PAT_TOKEN"
        } >> $GITHUB_OUTPUT
    
    - name: Setup environment variables
      shell: bash
      run: |
        echo "âœ… Environment variables configured"
        echo "   HTTP_PROXY: ${{ steps.resolve-config.outputs.http_proxy }}"
        echo "   HTTPS_PROXY: ${{ steps.resolve-config.outputs.https_proxy }}"
        echo "   REPORT_SERVER_URL: ${{ steps.resolve-config.outputs.report_server_url }}"
        
        echo "HTTP_PROXY=${{ steps.resolve-config.outputs.http_proxy }}" >> $GITHUB_ENV
        echo "HTTPS_PROXY=${{ steps.resolve-config.outputs.https_proxy }}" >> $GITHUB_ENV
        echo "REPORT_SERVER_URL=${{ steps.resolve-config.outputs.report_server_url }}" >> $GITHUB_ENV

